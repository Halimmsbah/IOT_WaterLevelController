<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Water Control System</title>
  <meta name="description" content="Water monitoring and control system">
  <meta name="keywords" content="water, control, monitoring">
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="assets/css/main.css" rel="stylesheet">
  <style>
    :root {
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --pollution-color: #8a2be2;
    }
    body {
      font-family: 'Roboto', sans-serif;
    }
    .water-level-display {
      position: relative;
      width: 100%;
      height: 200px;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    .water-level-bar {
      position: absolute;
      bottom: 0;
      width: 100%;
      background-color: #1e90ff;
      transition: height 1s ease;
    }
    .water-level-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .control-btn {
      width: 100%;
      padding: 12px;
      margin: 5px 0;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-on {
      background-color: var(--success-color);
    }
    .btn-off {
      background-color: var(--danger-color);
    }
    .alert-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      background-color: #f8f9fa;
    }
    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border-left: 5px solid var(--success-color);
    }
    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border-left: 5px solid var(--danger-color);
    }
    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border-left: 5px solid var(--warning-color);
    }
    .alert-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border-left: 5px solid var(--info-color);
    }
    .alert-pollution {
      background-color: #e9d8fd;
      color: var(--pollution-color);
      border-left: 5px solid var(--pollution-color);
    }
    #danger-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .last-update {
      font-size: 12px;
      color: #6c757d;
      text-align: right;
      margin-top: 10px;
    }
    .spinner {
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 5px;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .status-indicator {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
      border-left: 5px solid transparent;
    }
    .control {
      margin: 10px 0;
    }
    .parameters {
      margin: 15px 0;
    }
    .parameter {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .water-source-indicator {
  padding: 8px;
  border-radius: 5px;
  margin: 10px 0;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 8px;
}

.water-source-available {
  background-color: #d4edda;
  color: #155724;
  border-left: 4px solid var(--success-color);
}

.water-source-unavailable {
  background-color: #f8d7da;
  color: #721c24;
  border-left: 4px solid var(--danger-color);
  animation: pulse 2s infinite;
}

  </style>
</head>
<body class="index-page">
  <header id="header" class="header d-flex align-items-center fixed-top" style="background-color: rgb(19 35 63 / 90%);">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="index.html" class="logo d-flex align-items-center me-auto">
        <img src="assets/img/water-logo-drop-7.png" alt="">
        <h1 class="sitename">water conroller</h1>
      </a>
      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="home.html" class="active">Home</a></li>
          <li><a href="about2.html">About</a></li>
          <li><a href="services.html">Services</a></li>   
          <li><a href="teamMembers.html">Team</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="help.html">help</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
      <a class="btn-getstarted" href="login.html">Get Started</a>
    </div>
  </header>
  
  <main class="main">
    <section id="hero" class="hero section dark-background">
      <div class="container" style="padding-bottom: 4%;">
        <div class="row gy-4">
          <div class="col-lg-6 order-2 order-lg-1 d-flex flex-column justify-content-center">
            <h1>Tank Status</h1>
            <p>Real-time water tank monitoring and control system</p>
          </div>
          <div class="col-lg-6 order-1 order-lg-2 hero-img">
            <div class="card water-level">
              <header class="header2">
                <h1 style="color: #0e1d34; font-size: 23px;">Water Level</h1>
              </header>
              <h2><i class="bi bi-droplet"></i> Tank Level</h2>
              <div class="water-level-display">
                <div class="water-level-bar" style="height: 0%;"></div>
                <span class="water-level-text">0%</span>
              </div>
              <div class="water-source-indicator" id="water-source-indicator">
                <i class="bi bi-droplet-fill"></i>
                <span>Water Source: Checking...</span>
              </div>
              <div class="status-indicator" id="status-alert">System normal</div>
              <div class="control">
                <button id="mode-button" class="control-btn">Switch to Auto Mode</button>
              </div>
              <div class="control">
                <button id="pump-button" class="control-btn btn-off">Turn On Main Pump</button>
              </div>
              <div class="last-update">Last update: --:--:--</div>
            </div>
          </div>
        </div>
      </div>
      <div class="container" style="padding-bottom: 4%;">
        <div class="row gy-4">
          <div class="col-lg-6 order-2 order-lg-1 d-flex flex-column justify-content-center">
            <h1>Secondary Controls</h1>
            <p>Secondary pump and drain valve control</p>
          </div>
          <div class="col-lg-6 order-1 order-lg-2 hero-img">
            <div class="card water-level">
              <header class="header2">
                <h1 style="color: #0e1d34; font-size: 23px;">Secondary Controls</h1>
              </header>
              <div class="control">
                <button id="pump2-button" class="control-btn btn-off">Turn On Secondary Pump</button>
              </div>
              <div class="control">
                <button id="valve-button" class="control-btn btn-off">Open Drain Valve</button>
              </div>
              <div class="last-update">Last update: --:--:--</div>
            </div>
          </div>
        </div>
      </div>
      <div class="container" style="padding-bottom: 4%;">
        <div class="row gy-4">
          <div class="col-lg-6 order-2 order-lg-1 d-flex flex-column justify-content-center">
            <h1>Water Quality</h1>
            <p>Real-time water quality monitoring</p>
          </div>
          <div class="col-lg-6 order-1 order-lg-2 hero-img">
            <div class="card water-quality">
              <header class="header2">
                <h1 style="color: #0e1d34; font-size: 23px;">Water Quality</h1>
              </header>
              <h2><i class="bi bi-thermometer"></i> Quality Metrics</h2>
              <div class="parameters">
                <div class="parameter">
                  <span>Temperature: <span class="temperature-value">0Â°C</span></span>
                </div>
                <div class="parameter">
                  <span>Turbidity: <span class="turbidity-value">0 NTU</span></span>
                </div>
              </div>
              <div class="last-update">Last update: --:--:--</div>
            </div>
          </div>
        </div>
      </div>
      <div class="container" style="padding-bottom: 4%;">
        <div class="row gy-4">
          <div class="col-lg-6 order-2 order-lg-1 d-flex flex-column justify-content-center">
            <h1>System Alerts</h1>
            <p>Recent system events and notifications</p>
          </div>
          <div class="col-lg-6 order-1 order-lg-2 hero-img">
            <div class="card alerts">
              <header class="header2">
                <h1 style="color: #0e1d34; font-size: 23px;">System Alerts</h1>
              </header>
              <h2><i class="bi bi-bell"></i> Recent Alerts</h2>
              <div class="alert-list" id="alert-list">
                <div class="alert-item">Loading alerts...</div>
              </div>
              <div class="last-update">Last update: --:--:--</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <footer id="footer" class="footer dark-background">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-5 col-md-12 footer-about">
          <a href="index.html" class="logo d-flex align-items-center me-auto">
            <img src="assets/img/water-logo-drop-7.png" alt="System Logo">
            <h1 class="sitename">Water Control System</h1>
          </a>
        </div>
      </div>
    </div>
  </footer>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script>
    const POLLUTION_THRESHOLD = 250;
    let currentMode = localStorage.getItem('currentMode') || 'manual';
    // Initialize states as strings ("ON" or "OFF") based on localStorage
    let pumpState = localStorage.getItem('pumpState') || 'OFF';
    let pump2State = localStorage.getItem('pump2State') || 'OFF';
    let solenoidValveState = localStorage.getItem('solenoidValveState') || 'OFF';
    let lastAlertTime = null;
    let lastPollutionAlertTime = null;
    const API_BASE_URL = 'http://localhost:4000/api/v1/sensor';
    const refreshInterval = 3000;
    const elements = {
      waterLevelBar: document.querySelector('.water-level-bar'),
      waterLevelText: document.querySelector('.water-level-text'),
      temperatureValue: document.querySelector('.temperature-value'),
      turbidityValue: document.querySelector('.turbidity-value'),
      statusAlert: document.getElementById('status-alert'),
      alertList: document.getElementById('alert-list'),
      lastUpdateElements: document.querySelectorAll('.last-update'),
      buttons: {
        mode: document.getElementById('mode-button'),
        pump: document.getElementById('pump-button'),
        pump2: document.getElementById('pump2-button'),
        valve: document.getElementById('valve-button')
      }
    };
    document.addEventListener('DOMContentLoaded', () => {
      updateButtonStates();
      setupEventListeners();
      fetchRealTimeData();
      startAutoRefresh();
      addAlert('System initialized successfully', 'info');
    });
    function setupEventListeners() {
      if (elements.buttons.mode) {
        elements.buttons.mode.addEventListener('click', toggleMode);
      }
      if (elements.buttons.pump) {
        elements.buttons.pump.addEventListener('click', togglePump);
      }
      if (elements.buttons.pump2) {
        elements.buttons.pump2.addEventListener('click', togglePump2);
      }
      if (elements.buttons.valve) {
        elements.buttons.valve.addEventListener('click', toggleSolenoidValve);
      }
    }
    async function fetchRealTimeData() {
      try {
        const response = await fetch(`${API_BASE_URL}/realtime`);
        if (!response.ok) {
          throw new Error(`Network error: ${response.status}`);
        }
        const data = await response.json();
        if (data.success) {
          updateUI(data.data);
          checkForAlerts(data.data);
          updateLastUpdateTime(data.data.lastUpdate);
        } else {
          throw new Error('Server returned unsuccessful response');
        }
        return data;
      } catch (error) {
        addAlert(`Data update failed: ${error.message}`, 'danger');
        return null;
      }
    }
    // ÙØ¶ÙÙ Ø¯Ø§ÙØ© Ø¬Ø¯ÙØ¯Ø© ÙÙØªØ­ÙÙ ÙÙ ÙØµØ¯Ø± Ø§ÙÙÙØ§Ù
    async function checkWaterSource() {
      try {
        const response = await fetch(`${API_BASE_URL}/water-source`);
        const data = await response.json();
        
        if (data.alert) {
          showDangerAlert(data.alert);
          addAlert(data.alert, 'danger');
          
          // ØªØ¹Ø·ÙÙ Ø§ÙÙØ¶Ø®Ø© Ø¥Ø°Ø§ ÙÙ ÙÙÙ ÙÙØ§Ù ÙØµØ¯Ø± ÙÙØ§Ù
          if (pumpState === 'ON') {
            await togglePump();
          }
        }
      } catch (error) {
        console.error('Failed to check water source:', error);
      }
    }

    // ÙØ¹Ø¯Ù Ø¯Ø§ÙØ© startAutoRefresh ÙØ§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§ÙÙØ­Øµ Ø§ÙØ¬Ø¯ÙØ¯
    function startAutoRefresh() {
      setInterval(async () => {
        await fetchRealTimeData();
        await checkWaterSource(); // ÙØ¶ÙÙ ÙØ°Ø§ Ø§ÙØ³Ø·Ø±
      }, refreshInterval);
    }
    function updateUI(data) {
    if (!data) return;

    // ØªØ­Ø¯ÙØ« ÙØ¤Ø´Ø± ÙØµØ¯Ø± Ø§ÙÙÙØ§Ù
    const waterSourceIndicator = document.getElementById('water-source-indicator');
    if (waterSourceIndicator) {
        if (data.waterSourceStatus) {
            waterSourceIndicator.className = 'water-source-indicator water-source-available';
            waterSourceIndicator.innerHTML = `<i class="bi bi-droplet-fill"></i> <span>Water Source: Available</span>`;
        } else {
            waterSourceIndicator.className = 'water-source-indicator water-source-unavailable';
            waterSourceIndicator.innerHTML = `<i class="bi bi-droplet-fill"></i> <span>WARNING: No Water Source!</span>`;
            if (!document.getElementById('danger-modal')) {
                showDangerAlert('EMERGENCY: No water source detected!');
            }
        }
    }

    if (data.waterLevel !== undefined) {
        const waterLevel = Math.min(100, Math.max(0, data.waterLevel));
        elements.waterLevelBar.style.height = `${waterLevel}%`;
        elements.waterLevelText.textContent = `${waterLevel}%`;
    }
    if (data.temperature !== undefined) {
        elements.temperatureValue.textContent = `${data.temperature.toFixed(1)}Â°C`;
    }
    if (data.turbidity !== undefined) {
        elements.turbidityValue.textContent = `${data.turbidity} NTU`;
    }

    // ØªØ­Ø¯ÙØ« Ø­Ø§ÙØ© Ø§ÙØ£Ø²Ø±Ø§Ø± Ø¨ÙØ§Ø¡Ù Ø¹ÙÙ Ø§ÙØ­Ø§ÙØ© Ø§ÙÙØ­ÙÙØ© Ø£ÙÙØ§ÙØ Ø«Ù Ø§ÙÙÙÙ ÙÙ Firebase ÙÙ ÙÙÙØ´ ØªØºÙÙØ±Ø§Øª ÙØ­ÙÙØ©
    updateButtonStates();
}
    function updateButtonStates() {
      if (elements.buttons.mode) {
        elements.buttons.mode.textContent = currentMode === 'manual' 
          ? 'Switch to Auto Mode' 
          : 'Switch to Manual Mode';
        elements.buttons.mode.style.backgroundColor = currentMode === 'manual' 
          ? '#17a2b8' 
          : '#6c757d';
      }
      if (elements.buttons.pump) {
        elements.buttons.pump.textContent = pumpState === 'ON' 
          ? 'Turn Off Main Pump' 
          : 'Turn On Main Pump';
        elements.buttons.pump.className = `control-btn ${pumpState === 'ON' ? 'btn-on' : 'btn-off'}`;
        elements.buttons.pump.disabled = currentMode === 'automatic';
      }
      if (elements.buttons.pump2) {
        elements.buttons.pump2.textContent = pump2State === 'ON' 
          ? 'Turn Off Secondary Pump' 
          : 'Turn On Secondary Pump';
        elements.buttons.pump2.className = `control-btn ${pump2State === 'ON' ? 'btn-on' : 'btn-off'}`;
        elements.buttons.pump2.disabled = currentMode === 'automatic';
      }
      if (elements.buttons.valve) {
        elements.buttons.valve.textContent = solenoidValveState === 'ON' 
          ? 'Close Drain Valve' 
          : 'Open Drain Valve';
        elements.buttons.valve.className = `control-btn ${solenoidValveState === 'ON' ? 'btn-on' : 'btn-off'}`;
        elements.buttons.valve.disabled = currentMode === 'automatic';
      }
    }
    async function controlDevice(device, state) {
      try {
        setButtonsLoading(true);
        const response = await fetch(`${API_BASE_URL}/control`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            device: device,
            state: state
          }),
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Control failed');
        }
        const result = await response.json();
        return result;
      } catch (error) {
        addAlert(`FAILED to control ${device}: ${error.message}`, 'danger');
        throw error;
      } finally {
        setButtonsLoading(false);
      }
    }
    function setButtonsLoading(state) {
      const buttons = [
        elements.buttons.pump,
        elements.buttons.pump2,
        elements.buttons.valve
      ];
      buttons.forEach(btn => {
        if (btn) {
          btn.disabled = state || currentMode === 'automatic';
          if (state) {
            const originalText = btn.textContent;
            btn.innerHTML = `<i class="bi bi-arrow-repeat spinner"></i> ${originalText}`;
          } else {
            if (btn.id === 'pump-button') {
              btn.innerHTML = pumpState === 'ON' ? 'Turn Off Main Pump' : 'Turn On Main Pump';
            } else if (btn.id === 'pump2-button') {
              btn.innerHTML = pump2State === 'ON' ? 'Turn Off Secondary Pump' : 'Turn On Secondary Pump';
            } else if (btn.id === 'valve-button') {
              btn.innerHTML = solenoidValveState === 'ON' ? 'Close Drain Valve' : 'Open Drain Valve';
            }
          }
        }
      });
    }
    async function togglePump() {
      try {
        const newState = pumpState === 'OFF';
        const result = await controlDevice('pump', newState);
        pumpState = newState ? 'ON' : 'OFF';
        localStorage.setItem('pumpState', pumpState);
        updateButtonStates();
        addAlert(`Main Pump ${newState ? 'STARTED' : 'STOPPED'}`, newState ? 'success' : 'info');
        return result;
      } catch (error) {
        updateButtonStates();
      }
    }
    async function togglePump2() {
      try {
        const newState = pump2State === 'OFF';
        const result = await controlDevice('pump2', newState);
        pump2State = newState ? 'ON' : 'OFF';
        localStorage.setItem('pump2State', pump2State);
        updateButtonStates();
        addAlert(`Secondary Pump ${newState ? 'STARTED' : 'STOPPED'}`, newState ? 'success' : 'info');
        return result;
      } catch (error) {
        updateButtonStates();
      }
    }
    async function toggleSolenoidValve() {
      try {
        const newState = solenoidValveState === 'OFF';
        const result = await controlDevice('solenoidValve', newState);
        solenoidValveState = newState ? 'ON' : 'OFF';
        localStorage.setItem('solenoidValveState', solenoidValveState);
        updateButtonStates();
        addAlert(`Drain Valve ${newState ? 'OPENED' : 'CLOSED'}`, newState ? 'success' : 'info');
        return result;
      } catch (error) {
        updateButtonStates();
      }
    }
    function toggleMode() {
      currentMode = currentMode === 'manual' ? 'automatic' : 'manual';
      localStorage.setItem('currentMode', currentMode);
      if (currentMode === 'automatic') {
        fetchRealTimeData();
      }
      addAlert(`Switched to ${currentMode === 'manual' ? 'Manual' : 'Auto'} mode`, 'info');
      updateButtonStates();
    }
    function checkForAlerts(data) {
      const now = new Date().toISOString();
      if (data.waterLevel < 10 && lastAlertTime !== now) {
        showDangerAlert('CRITICAL WATER LEVEL!');
        addAlert('WARNING: Water level critically low!', 'danger');
        lastAlertTime = now;
      }
      if (data.turbidity > POLLUTION_THRESHOLD && lastPollutionAlertTime !== now) {
        showDangerAlert('HIGH POLLUTION DETECTED!');
        addAlert(`WARNING: High pollution (${data.turbidity} NTU)`, 'pollution');
        lastPollutionAlertTime = now;
      }
      updateStatusAlert(data);
    }
    function updateStatusAlert(data) {
      if (!elements.statusAlert) return;
      if (data.waterLevel < 10 || data.turbidity > POLLUTION_THRESHOLD) {
        elements.statusAlert.textContent = 'CRITICAL STATUS!';
        elements.statusAlert.className = 'status-indicator alert-danger';
      } else if (data.waterLevel < 20) {
        elements.statusAlert.textContent = 'Warning: Low water level';
        elements.statusAlert.className = 'status-indicator alert-warning';
      } else {
        elements.statusAlert.textContent = 'System normal';
        elements.statusAlert.className = 'status-indicator alert-success';
      }
    }
    function addAlert(message, type) {
      if (!elements.alertList) return;
      const alertItem = document.createElement('div');
      alertItem.className = `alert-item alert-${type}`;
      const time = new Date().toLocaleTimeString();
      alertItem.innerHTML = `<span>${time} - ${message}</span>`;
      elements.alertList.insertBefore(alertItem, elements.alertList.firstChild);
      if (elements.alertList.children.length > 10) {
        elements.alertList.removeChild(elements.alertList.lastChild);
      }
    }
    function showDangerAlert(message) {
      const modal = document.createElement('div');
      // modal.id = 'danger-modal';
      // modal.innerHTML = `
      //   <div class="modal-content">
      //     <span class="close-btn" onclick="this.parentElement.parentElement.remove()">&times;</span>
      //     <i class="bi bi-exclamation-triangle-fill" style="color: red; font-size: 3rem;"></i>
      //     <h2>EMERGENCY ALERT!</h2>
      //     <p>${message}</p>
      //     <p>Immediate action required</p>
      //   </div>
      // `;
      document.body.appendChild(modal);
      setTimeout(() => {
        if (document.body.contains(modal)) {
          document.body.removeChild(modal);
        }
      }, 10000);
    }
    function updateLastUpdateTime(timestamp) {
      if (!timestamp || !elements.lastUpdateElements) return;
      const date = new Date(timestamp);
      const timeString = date.toLocaleTimeString();
      elements.lastUpdateElements.forEach(el => {
        el.textContent = `Last update: ${timeString}`;
      });
    }
  </script>
</body>
</html>